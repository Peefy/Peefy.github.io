"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[26565],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},m="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=c(n),h=i,d=m["".concat(l,".").concat(h)]||m[h]||p[h]||r;return n?a.createElement(d,o(o({ref:t},u),{},{components:n})):a.createElement(d,o({ref:t},u))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},27649:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var a=n(87462),i=(n(67294),n(3905));const r={slug:"2022-kcl-rewrite-with-rust",title:"40x Faster! We rewrote our project with Rust",authors:{name:"Pengfei, Xu",title:"KCL Team Member"},tags:["KCL","Rust","Performance","Programming Language","Compiler"]},o=void 0,s={permalink:"/blog/2022-kcl-rewrite-with-rust",editUrl:"https://github.com/kcl-lang/kcl-lang.io/tree/main/blog/2022-11-29-kcl-rewrite-with-rust/index.md",source:"@site/blog/2022-11-29-kcl-rewrite-with-rust/index.md",title:"40x Faster! We rewrote our project with Rust",description:"Introduction",date:"2022-11-29T00:00:00.000Z",formattedDate:"November 29, 2022",tags:[{label:"KCL",permalink:"/blog/tags/kcl"},{label:"Rust",permalink:"/blog/tags/rust"},{label:"Performance",permalink:"/blog/tags/performance"},{label:"Programming Language",permalink:"/blog/tags/programming-language"},{label:"Compiler",permalink:"/blog/tags/compiler"}],readingTime:9.745,hasTruncateMarker:!1,authors:[{name:"Pengfei, Xu",title:"KCL Team Member"}],frontMatter:{slug:"2022-kcl-rewrite-with-rust",title:"40x Faster! We rewrote our project with Rust",authors:{name:"Pengfei, Xu",title:"KCL Team Member"},tags:["KCL","Rust","Performance","Programming Language","Compiler"]},prevItem:{title:"KCL v0.4.4 Release Blog",permalink:"/blog/2022-kcl-0.4.4-release-blog"},nextItem:{title:"KCL Introduction on SETTA 2022 Meeting",permalink:"/blog/2022-kcl-setta-meeting"}},l={authorsImageUrls:[void 0]},c=[{value:"Introduction",id:"introduction",level:2},{value:"What problems have we encountered",id:"what-problems-have-we-encountered",level:2},{value:"Why use Rust",id:"why-use-rust",level:2},{value:"What are the difficulties in using Rust",id:"what-are-the-difficulties-in-using-rust",level:2},{value:"Mental transformation",id:"mental-transformation",level:3},{value:"Development efficiency",id:"development-efficiency",level:3},{value:"Rewrite revenue ratio using Rust",id:"rewrite-revenue-ratio-using-rust",level:2},{value:"Conclusion",id:"conclusion",level:2},{value:"Reference",id:"reference",level:2}],u={toc:c},m="wrapper";function p(e){let{components:t,...n}=e;return(0,i.kt)(m,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"Rust has quietly become one of the most popular programming languages. As an popular emerging system language, Rust has many great characteristics, such as its memory security mechanism, performance close to that of C/C++, an excellent development community and helpful documentation, tool chains and IDEs. In this blog, we will introduce the process of using Rust for a rewrite and gradually implementing the production environment, as well as the reasons for choosing Rust, any issues we have encountered, and the results of the rewrite."),(0,i.kt)("p",null,"The project we are using Rust to develop is called ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/kcl-lang/kcl"},"KCL"),". KCL is an open-source, constraint-based record and functional programming language. It leverages mature programming language technology and practice to facilitate the writing of many complex configurations. KCL is designed to improve modularity, scalability, and stability around configuration, simplify logic writing, speed up automation and create a thriving extension ecosystem. To learn more about specific KCL usage scenarios, please refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://kcl-lang.github.io/"},"KCL website"),". This blog will not go into too much detail about that."),(0,i.kt)("p",null,"KCL was written in Python before. After carefully evaluating the user experience, performance and stability, we decided to rewrite KCL in Rust, and the following benefits were obtained:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Rust's powerful compilation checks and error handling led to fewer bugs."),(0,i.kt)("li",{parentName:"ul"},"There was a 66% improvement in end-to-end compilation and execution performance."),(0,i.kt)("li",{parentName:"ul"},"The language front-end parser performance improved by up to 20 times."),(0,i.kt)("li",{parentName:"ul"},"The language semantic analyzer performance improved by up to 40 times."),(0,i.kt)("li",{parentName:"ul"},"The average memory usage of the language compiler during compilation was roughly half of the original Python version.")),(0,i.kt)("h2",{id:"what-problems-have-we-encountered"},"What problems have we encountered"),(0,i.kt)("p",null,"The compiler, build system or runtime uses Rust to do similar things in technology like projects of the same type in the community ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/denoland/deno"},"deno"),", ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/swc-project/swc"},"swc"),", ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/vercel/turbo"},"turbopack"),", ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/rust-lang/rust"},"rustc"),". We used Rust to completely build the front, middle and runtime of the compiler, and achieved some results, but we did not do this about a year ago."),(0,i.kt)("p",null,"A year ago, we used Python to build the entire KCL compiler implementation, which initially ran well due to Python\u2019s ease of use, rich ecosystem, and the team's high research and development efficiency. However, as the codebase and number of engineers grew, code maintenance became increasingly difficult. To counter this, we enforced the usage of Python type annotations and employed stricter linting tools, as well as achieving >90% code test coverage. Yet, runtime errors such as empty Python objects and missing attributes remained, and refactoring had to be done with caution."),(0,i.kt)("p",null,"As KCL users are mostly developers, any mishaps in the language or compiler internals were unacceptable, leading to a range of issues with user experience. Furthermore, programs written in Python had slow startup times, and their performance did not meet the efficiency demands of automating the online compilation and execution. Therefore, a compiler written in Python was unable to adequately meet use requirements."),(0,i.kt)("p",null,"Consequently, we decided to rewrite KCL in Rust to not only improve user experience, but to also benefit from Rust\u2019s powerful compilation checks and error handling. This led to a 66% improvement in end-to-end compilation and execution performance, as well as a 20- and 40-fold improvement in the language front-end and semantic analyser performance, respectively. The average memory usage of the compiler during compilation was also roughly halved."),(0,i.kt)("h2",{id:"why-use-rust"},"Why use Rust"),(0,i.kt)("p",null,"We chose Rust for the following reasons:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"We implemented a simple programming language stack virtual machine in Python, Go, and Rust and conducted a performance comparison, Rust was adopted under comprehensive consideration as Go and Rust had similar performance whereas Python had a large performance gap. The details of the stack virtual machine code implemented by the three languages are here: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/Peefy/StackMachine"},"https://github.com/Peefy/StackMachine"),"."),(0,i.kt)("li",{parentName:"ul"},"Rust has been widely utilized for compilers or runtimes of programming languages, especially in front-end infrastructure projects, and is present in various fields such as infrastructure, database, search engine, network, cloud-native, UI, and embedded systems, ensuring its feasibility and stability."),(0,i.kt)("li",{parentName:"ul"},"Considering that the subsequent project development will involve the direction of blockchain and smart contract, and a large number of blockchain and smart contract projects in the community are written by Rust."),(0,i.kt)("li",{parentName:"ul"},"Rust provides better performance and stability, making the system easier to maintain and more robust, while allowing developers to expose C APIs through FFI for multilingual use and expansion."),(0,i.kt)("li",{parentName:"ul"},"Rust's friendly support for Web Assembly (WASM) is extremely beneficial for the development of blockchain and smart contract projects.")),(0,i.kt)("p",null,"Based on the above reasons, we chose Rust instead of Go. In the whole rewriting process, we found that Rust's comprehensive quality is impressive because it not only provides high performance but also a sufficient abstraction, although there is some cost in certain language features such as lifetime. Nevertheless, its ecology is not as rich as other languages."),(0,i.kt)("h2",{id:"what-are-the-difficulties-in-using-rust"},"What are the difficulties in using Rust"),(0,i.kt)("p",null,"Although we decided to rewrite the entire KCL project with Rust, most team members have no experience in writing a certain project with Rust, and I has only learned ",(0,i.kt)("a",{parentName:"p",href:"https://doc.rust-lang.org/book/"},"The Rust Programming Language"),". I vaguely remember that I gave up when I learned about intelligent pointers such as ",(0,i.kt)("inlineCode",{parentName:"p"},"Rc")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"RefCell"),". At that time, I didn't expect that there would be anything similar to C++ in Rust."),(0,i.kt)("p",null,"The risk of utilizing Rust is mainly the expense of learning the language, which is evidently discussed in a multitude of Rust blogs. Seeing that the overall structure of the KCL project had not been altered considerably, and some modules' designs and their code had been greatly improved for Rust, the entire rewrite was accomplished through a process of mastering Rust whilst practicing. When we set out to use Rust to create the whole project, time was spent on knowledge querying, compilation and debugging. As the project advanced, however, the main challenges that arose from utilizing Rust were mainly the transformation of our mindsets, as well as the efficiency of development."),(0,i.kt)("h3",{id:"mental-transformation"},"Mental transformation"),(0,i.kt)("p",null,'First of all, the syntax and semantics of Rust well absorb and integrate the concepts related to the type system in functional programming, such as the Abstract Algebraic Type (ADT). In addition, there is no concept related to "inheritance" in Rust. If you can\'t understand it well, even ordinary structure definitions in other languages may take a lot of time in Rust. For example, the following Python code may be defined like this in Rust.'),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Python")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"from dataclasses import dataclass\n\nclass KCLObject:\n    pass\n\n@dataclass\nclass KCLIntObject(KCLObject):\n    value: int\n\n@dataclass\nclass KCLFloatObject(KCLObject):\n    value: float\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Rust")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"enum KCLObject {\n    Int(u64),\n    Float(f64),\n}\n")),(0,i.kt)("p",null,'Of course, more time is spent fighting against the error reports of the Rust compiler itself. The Rust compiler will often cause developers to "run into a wall", such as borrowing check errors. Especially for the KCL compiler, its core structure is the Abstract Syntax Tree (AST), which is a recursive and nested tree structure.'),(0,i.kt)("p",null,"It is sometimes difficult to give consideration to the relationship between variable variability and borrowing check in Rust, Just like the scope structure ",(0,i.kt)("inlineCode",{parentName:"p"},"Scope")," defined in KCL compiler, for scenarios with circular references, it is used to display the interdependence of data that needs to be aware of, while making extensive use of intelligent pointer structures commonly used in Rust such as ",(0,i.kt)("inlineCode",{parentName:"p"},"Rc"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"RefCell")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"Weak"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"/// A Scope maintains a set of objects and links to its containing\n/// (parent) and contained (children) scopes. Objects may be inserted\n/// and looked up by name. The zero value for Scope is a ready-to-use\n/// empty scope.\n#[derive(Clone, Debug)]\npub struct Scope {\n    /// The parent scope.\n    pub parent: Option<Weak<RefCell<Scope>>>,\n    /// The child scope list.\n    pub children: Vec<Rc<RefCell<Scope>>>,\n    /// The scope object mapping with its name.\n    pub elems: IndexMap<String, Rc<RefCell<ScopeObject>>>,\n    /// The scope start position.\n    pub start: Position,\n    /// The scope end position.\n    pub end: Position,\n    /// The scope kind.\n    pub kind: ScopeKind,\n}\n")),(0,i.kt)("h3",{id:"development-efficiency"},"Development efficiency"),(0,i.kt)("p",null,"The efficiency of utilizing Rust may appear low at first, but it will become substantially high upon gaining familiarity with it. Initially, if the team members have not been exposed to concepts such as functional programming and related coding practices, the development speed will be much slower than that of languages such as Python, Go, and Java. Nevertheless, once they become familiarized with the conventional methods and best practices of the Rust standard library, as well as the common fixes for Rust compiler errors, the development efficiency will be dramatically boosted, and they will be able to compose high-quality, safe, and efficient code naturally."),(0,i.kt)("p",null,"For instance, I ran into a Rust lifetime error in the following code. After troubleshooting for a lengthy duration, it became apparent that the lifetime inconsistency was due to neglecting to label lifetime parameters. Additionally, Rust\u2019s lifetime is combined with concepts such as type system, scope, ownership, and borrowing inspection, resulting in a higher cost and complexity of understanding, with error reporting information often not as clear-cut as type errors. The lifetime inconsistency error reporting information can sometimes be somewhat inflexible, which may lead to a costly troubleshooting procedure. Of course, efficiency will be improved with increasing familiarity with the pertinent concepts."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"struct Data<'a> {\n    b: &'a u8,\n}\n\n// func2 omit lifecycle parameters, and func2 does not.\n// The lifecycle of func2 will be deduced as '_ by the Rust compiler by default,\n// which may lead to lifetime mismatch error.\nimpl<'a> Data<'a> {\n    fn func1(&self) -> Data<'a> {Data { b: &0 }}\n    fn func2(&self) -> Data {Data { b: &0 }}\n}\n")),(0,i.kt)("h2",{id:"rewrite-revenue-ratio-using-rust"},"Rewrite revenue ratio using Rust"),(0,i.kt)("p",null,"After spending several months using Rust to completely rewrite and steadily deploy the KCL project into a production environment, we have looked back on the whole process and found it highly rewarding."),(0,i.kt)("p",null,"From a technical point of view, the rewrite process not only trained us to quickly learn a new programming language and its associated knowledge, but it also enabled us to put them into practice. The whole rewrite process also made us reflect on the unrational design of the KCL compiler and modify it accordingly. For a programming language, this is a long-cycle project. We have learned that such a compiler system should be more stable, and secure, with legible code, fewer bugs, and better performance."),(0,i.kt)("p",null,"Although not all modules achieved a 40-fold improvement in performance (due to memory deep copy operations being the main bottleneck of some modules, such as the KCL runtime), I still think it is particularly beneficial. With enough experience in Rust, mental and development efficiency are no longer limiting factors."),(0,i.kt)("p",null,"Overall, although our team encountered obstacles while using Rust to rewrite the KCL project, we eventually succeeded. We have acquired invaluable knowledge and experience in the process, which will be immensely beneficial in the future."),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"I personally think that the most important thing after using Rust to rewrite the project is whether I have learned a new programming language or whether Rust is very popular and we have written many fancy codes using Rust. The stability, startup-time, and automation-efficiency of the KCL compiler and language is significantly improved. Furthermore, with Rust's non-GC, high-performance, improved error handling, memory management, and lack of abstraction, the performance of KCL improves substantially as compared to other languages in similar fields. In short, the users of KCL are the biggest beneficiaries of the improvements made possible by Rust."),(0,i.kt)("p",null,"If you are interested in the KCL project, wish to use KCL for your personal use cases, or want to use Rust to participate in an open-source project, welcome to visit ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/kcl-lang/community"},"https://github.com/kcl-lang/community")," to join our community to participate in discussion and co construction \ud83d\udc4f\ud83d\udc4f\ud83d\udc4f\u3002"),(0,i.kt)("h2",{id:"reference"},"Reference"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/kcl-lang/kcl"},"https://github.com/kcl-lang/kcl")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/Peefy/StackMachine"},"https://github.com/Peefy/StackMachine")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://doc.rust-lang.org/book/"},"https://doc.rust-lang.org/book/")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/sunface/rust-course"},"https://github.com/sunface/rust-course")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.influxdata.com/blog/rust-can-be-difficult-to-learn-and-frustrating-but-its-also-the-most-exciting-thing-in-software-development-in-a-long-time/"},"https://www.influxdata.com/blog/rust-can-be-difficult-to-learn-and-frustrating-but-its-also-the-most-exciting-thing-in-software-development-in-a-long-time/"))))}p.isMDXComponent=!0}}]);