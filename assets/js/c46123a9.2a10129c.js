"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[23378],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>h});var a=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=a.createContext({}),d=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=d(e.components);return a.createElement(s.Provider,{value:n},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=d(t),u=i,h=c["".concat(s,".").concat(u)]||c[u]||m[u]||r;return t?a.createElement(h,o(o({ref:n},p),{},{components:t})):a.createElement(h,o({ref:n},p))}));function h(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[c]="string"==typeof e?e:i,o[1]=l;for(var d=2;d<r;d++)o[d]=t[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},75987:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var a=t(87462),i=(t(67294),t(3905));const r={slug:"2023-06-05-k8s-sidecar-1",title:"Talking about the Sidecar design pattern in K8S - Part 1",authors:{name:"KCL Team",title:"KCL Team"},tags:["KCL","k8s","Sidecar"]},o=void 0,l={permalink:"/blog/2023-06-05-k8s-sidecar-1",editUrl:"https://github.com/kcl-lang/kcl-lang.io/tree/main/blog/2023-06-05-k8s-sidecar-1/index.md",source:"@site/blog/2023-06-05-k8s-sidecar-1/index.md",title:"Talking about the Sidecar design pattern in K8S - Part 1",description:"Introduction",date:"2023-06-05T00:00:00.000Z",formattedDate:"June 5, 2023",tags:[{label:"KCL",permalink:"/blog/tags/kcl"},{label:"k8s",permalink:"/blog/tags/k-8-s"},{label:"Sidecar",permalink:"/blog/tags/sidecar"}],readingTime:5.265,hasTruncateMarker:!1,authors:[{name:"KCL Team",title:"KCL Team"}],frontMatter:{slug:"2023-06-05-k8s-sidecar-1",title:"Talking about the Sidecar design pattern in K8S - Part 1",authors:{name:"KCL Team",title:"KCL Team"},tags:["KCL","k8s","Sidecar"]},prevItem:{title:"Talking about the SideCar design pattern in K8S - Part 2",permalink:"/blog/2023-06-29-k8s-sidecar-2"},nextItem:{title:"Differences between KCL and Helm",permalink:"/blog/2023-05-30-vs-helm"}},s={authorsImageUrls:[void 0]},d=[{value:"Introduction",id:"introduction",level:2},{value:"A Cloud-Native Minimalist Web Services",id:"a-cloud-native-minimalist-web-services",level:2},{value:"Expand the page content by Sidecar",id:"expand-the-page-content-by-sidecar",level:2},{value:"How Sidecar mode works",id:"how-sidecar-mode-works",level:2},{value:"Advantages of Sidecar",id:"advantages-of-sidecar",level:2},{value:"Summary",id:"summary",level:2}],p={toc:d},c="wrapper";function m(e){let{components:n,...r}=e;return(0,i.kt)(c,(0,a.Z)({},p,r,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"In ",(0,i.kt)("inlineCode",{parentName:"p"},"K8S"),", there is a design pattern called ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar"),", The ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," pattern deploys application components into a separate process or container to provide isolation and encapsulation. And it also allows applications to be composed of heterogeneous components and technologies."),(0,i.kt)("p",null,"This pattern is named ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," because it resembles a Sidecar attached to a motorcycle. The Sidecar connects to a parent application and provides support functions for the application. The Sidecar also shares the same lifecycle as the parent application, being created and retired alongside the parent. The Sidecar pattern is sometimes referred to as the sidepick pattern and is a decomposition pattern."),(0,i.kt)("p",null,"This series of articles will show the usage of the ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," pattern and how to use the ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," pattern by KCL."),(0,i.kt)("h2",{id:"a-cloud-native-minimalist-web-services"},"A Cloud-Native Minimalist Web Services"),(0,i.kt)("p",null,"At first, we could start a web service in our kubernetes environment. Define a pod with only one ",(0,i.kt)("inlineCode",{parentName:"p"},"Nginx")," service and start a web service on port 80 in the ",(0,i.kt)("inlineCode",{parentName:"p"},"pod.yaml")," file below."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Pod\nmetadata:\n  name: web-app\nspec:\n  containers:\n  - image: nginx\n    name: main-container\n    ports:\n      - containerPort: 80\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Pod")," is a foundational primitive in cloud native. ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod")," wraps multiple containers into a single logical unit, and the kubernetes runtime ensures that the containers in a ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod")," run on a single machine. So all containers in a ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod")," share lifecycles, disk volumes, network, etc. The ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," pattern is about adding other containers to a ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod")," to extend and augment the capabilities of the main container."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod")," is then created via the kubectl, and then the ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod")," execution status is viewed via ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl get po"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl create -f pod.yaml\n$ kubectl get po\nNAME READY STATUS RESTARTS AGE\nweb-app 1/1 Running 0 45m\n")),(0,i.kt)("p",null,"You can see that a ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod")," named ",(0,i.kt)("inlineCode",{parentName:"p"},"web-app")," is up and running properly, containing the ",(0,i.kt)("inlineCode",{parentName:"p"},"Nginx")," service. To configure port forwarding for external access, the port 3999 of the host corresponds to port 80 of the master container:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl port-forward web-app 3999:80\nForwarding from 127.0.0.1:3999 ->80\nForwarding from [::1]:3999 -> 80\n")),(0,i.kt)("p",null,"Port forwarding is a blocking procedure, keep the command line open. Then open the test page in your browser at"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(61074).Z,width:"1136",height:"614"})),(0,i.kt)("h2",{id:"expand-the-page-content-by-sidecar"},"Expand the page content by Sidecar"),(0,i.kt)("p",null,"In this section, we try to add the ability to customize web pages to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Nginx")," service via Sidecar without modifying the original ",(0,i.kt)("inlineCode",{parentName:"p"},"Nginx")," container image. Before we start, remove the previously started ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl delete po web-app\npod "web-app" deleted\n')),(0,i.kt)("p",null,"Then add a second ",(0,i.kt)("inlineCode",{parentName:"p"},"Busybox")," Sidecar container to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod"),", with the ",(0,i.kt)("inlineCode",{parentName:"p"},"pod.yaml")," file as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nmetadata:\n  name: web-app\nspec:\n  containers:\n  - image: nginx\n    name: main-container\n    ports:\n      - containerPort: 80\n\n    # --- Here are the new additions ---\n\n    # andSidecar share file directories to be published via disk volumes\n    volumeMounts:\n    - name: var-logs\n      mountPath: /usr/share/nginx/html\n  \n  # Sidecar Container\n  - image: busybox\n    command: ["/bin/sh"]\n    args: ["-c", "while true; do echo $(date -u) \'Hi I am from Sidecar container\' > /var/log/index.html; sleep 5;done"]\n    name: Sidecar-container\n    volumeMounts: var-logs\n      mountPath: /var/log\n\n  # All containers in Pod share disk volumes\n  volumes:\n  - name: var-logs\n    emptyDir: {}\n\n')),(0,i.kt)("p",null,"The commands executed by the ",(0,i.kt)("inlineCode",{parentName:"p"},"Busybox")," Sidecar container correspond to the following shell scripts:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"while true; do\n    echo $(date -u) 'Hi I am from Sidecar container' > /var/log/index.html;\n    sleep 5;\ndone\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Busybox")," has only one function: it overwrites the ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/log/index.html")," file every 5 seconds, which happens to correspond to the home page file of the Nginx service."),(0,i.kt)("p",null,"Then restart the Pod and remap the local host port to the container port."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl create -f pod.yaml \npod/web-app created\n$ kubectl port-forward web-app 3999:80\nForwarding from 127.0.0.1:3999 -> 80\nForwarding from [::1]:3999 -> 80\n")),(0,i.kt)("p",null,"Upon reopening your browser you will see the following page:"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(53964).Z,width:"1038",height:"192"})),(0,i.kt)("h2",{id:"how-sidecar-mode-works"},"How Sidecar mode works"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Busybox")," is a ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," container that produces the home page data, while ",(0,i.kt)("inlineCode",{parentName:"p"},"Nginx")," is the main container that consumes the home page data produced by ",(0,i.kt)("inlineCode",{parentName:"p"},"Busybox"),"; the two containers share space through the var-logs disk volume."),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(34218).Z,width:"1066",height:"658"})),(0,i.kt)("p",null,"In the example, ",(0,i.kt)("inlineCode",{parentName:"p"},"Nginx")," is still the main container, and the ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," container is BusyBox. we can also add more ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," containers for network, monitoring, logging, etc."),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(23890).Z,width:"1512",height:"616"})),(0,i.kt)("h2",{id:"advantages-of-sidecar"},"Advantages of Sidecar"),(0,i.kt)("p",null,"Containers have now become a popular packaging technology, where various teams can build, publish and run programs in a unified way, and even manage various resources through containers. So a container is more like a product with its own runtime, release cycle, documentation, API, etc. A good container/product is responsible for solving only one problem, and maintaining the KISS principle allows the container itself to be extremely reusable and replaceable."),(0,i.kt)("p",null,"It is reusability that makes the modern build process more agile and efficient. But reusable containers are generally single-function, and we often need to extend the functionality of containers, as well as the need for more collaboration between containers."),(0,i.kt)("p",null,"The Sidecar can be added lots of trailers without modifying the main motorcycle, and accordingly the ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," pattern can extend and enhance the existing main container functions without modifying the main container."),(0,i.kt)("p",null,'There is a rule in object-oriented programming that "combination is better than inheritance, use more combination and less inheritance", so ',(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," is also a recommended pattern to use. Because of the advantages of the Sidecar pattern, it has recently been used in a lot of cloud-native scenarios. For example, it can be used to encrypt communication between Pods through a service mesh or to act as a database proxy. Sidecar containers can be used for log forwarding (e.g., ",(0,i.kt)("inlineCode",{parentName:"p"},"fluentd"),"), Service Mesh (e.g., ",(0,i.kt)("inlineCode",{parentName:"p"},"Istio"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"Linkerd"),"), proxying (e.g., ",(0,i.kt)("inlineCode",{parentName:"p"},"Docker Ambassador"),"), health checking (to check if certain components are working properly), and other auxiliary tasks (such as copying files or downloading files)."),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,"In this article, we briefly introduce and demonstrate the ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," pattern, while comparing the relationship between ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," pattern and the combinatorial programming pattern in the context of traditional object-oriented programming ideas. the advantages of the ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," pattern are not only in the harmless enhancement of the main container, but also in the more flexible ability to dynamically adjust the main container capability."),(0,i.kt)("p",null,"In later articles, we will try to simplify writing ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," configurations by modern cloud-native configuration languages such as ",(0,i.kt)("inlineCode",{parentName:"p"},"KCL"),". Extending existing configuration based on ",(0,i.kt)("inlineCode",{parentName:"p"},"Sidecar")," by dynamically injecting and modifying it through ",(0,i.kt)("inlineCode",{parentName:"p"},"KCL"),"."))}m.isMDXComponent=!0},23890:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/how-sidecar-work-1-1670ff5790f17bd1be1f502f404d8a7e.png"},34218:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/how-sidecar-work-0c950a059d9aeb53ecee68e3509baf64.png"},53964:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/port-forward-1-3d8c5e37622b12a92121d7f040f52825.png"},61074:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/port-forward-fcc6e21e525bbdb7d267d01ffc61c85c.png"}}]);